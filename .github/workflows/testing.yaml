---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# Action test/validation workflow
name: "Test GitHub Action ðŸ§ª"

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions: {}

jobs:
  ### Test the GitHub Action in this Repository ###
  tests:
    name: "Test local GitHub Action"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 15 # Increased for comprehensive redirect tests
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: "Checkout repository"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      ### Setup local go-httpbin service for reliable testing ###
      - name: 'Setup local go-httpbin service'
        id: httpbin
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/go-httpbin-action@01efd756b33c0661ee585d7546300783511d9fb8
        with:
          skip-certificate: 'true'  # Use HTTP for simpler testing
          debug: 'true'

      ### Basic URL Validity Tests ###

      # Test with a valid URL that should always work
      - name: 'Test valid URL (Google)'
        id: test-valid
        uses: ./
        with:
          url: 'https://www.google.com'

      - name: 'Verify valid URL test passed'
        shell: bash
        run: |
          if [ "${{ steps.test-valid.outputs.valid }}" != "true" ]; then
            echo 'Error: Valid URL test failed âŒ'
            exit 1
          fi
          echo 'Valid URL test passed âœ…'

      # Test with an invalid URL that should fail
      - name: 'Test invalid URL'
        id: test-invalid
        uses: ./
        with:
          url: 'https://this-domain-should-not-exist-12345.invalid'

      - name: 'Verify invalid URL test failed as expected'
        shell: bash
        run: |
          if [ "${{ steps.test-invalid.outputs.valid }}" != "false" ]; then
            echo 'Error: Invalid URL test should have failed âŒ'
            exit 1
          fi
          echo 'Invalid URL test failed as expected âœ…'

      # Test with Linux Foundation URL (real world example)
      - name: 'Test Linux Foundation URL'
        id: test-lf
        uses: ./
        with:
          url: 'https://linuxfoundation.org'

      - name: 'Verify Linux Foundation URL test'
        shell: bash
        run: |
          if [ "${{ steps.test-lf.outputs.valid }}" != "true" ]; then
            echo 'Error: Linux Foundation URL test failed âŒ'
            exit 1
          fi
          echo 'Linux Foundation URL test passed âœ…'

      ### Enhanced Tests Using Local go-httpbin ###

      # Test 200 OK status
      - name: 'Test 200 OK status'
        id: test-200
        uses: ./
        with:
          url: '${{ steps.httpbin.outputs.service-url }}/status/200'

      - name: 'Verify 200 OK test results'
        shell: bash
        run: |
          if [ "${{ steps.test-200.outputs.valid }}" != "true" ]; then
            echo 'Error: 200 OK test failed âŒ'
            exit 1
          fi
          if [ "${{ steps.test-200.outputs.http_code }}" != "200" ]; then
            echo 'Error: Expected HTTP 200, got' \
              '${{ steps.test-200.outputs.http_code }} âŒ'
            exit 1
          fi
          echo '200 OK test passed âœ…'

      # Test 404 Not Found status
      - name: 'Test 404 Not Found status'
        id: test-404
        uses: ./
        with:
          url: '${{ steps.httpbin.outputs.service-url }}/status/404'

      - name: 'Verify 404 Not Found test results'
        shell: bash
        run: |
          if [ "${{ steps.test-404.outputs.valid }}" != "false" ]; then
            echo 'Error: 404 test should have failed âŒ'
            exit 1
          fi
          if [ "${{ steps.test-404.outputs.http_code }}" != "404" ]; then
            echo 'Error: Expected HTTP 404, got' \
              '${{ steps.test-404.outputs.http_code }} âŒ'
            exit 1
          fi
          echo '404 Not Found test passed âœ…'

      # Test single redirect
      - name: 'Test single redirect'
        id: test-redirect-1
        uses: ./
        with:
          url: '${{ steps.httpbin.outputs.service-url }}/redirect/1'

      - name: 'Verify single redirect test results'
        shell: bash
        run: |
          if [ "${{ steps.test-redirect-1.outputs.valid }}" != "true" ]; then
            echo 'Error: Single redirect test failed âŒ'
            exit 1
          fi
          if [ "${{ steps.test-redirect-1.outputs.http_code }}" != "200" ]; then
            echo 'Error: Expected final HTTP 200, got' \
              '${{ steps.test-redirect-1.outputs.http_code }} âŒ'
            exit 1
          fi
          if [ -z "${{ steps.test-redirect-1.outputs.redirect_url }}" ]; then
            echo 'Error: Expected redirect URL to be captured âŒ'
            exit 1
          fi
          if [ "${{ steps.test-redirect-1.outputs.redirect_valid }}" != "true" ]
          then
            echo 'Error: Expected redirect to be valid âŒ'
            exit 1
          fi
          if [ "${{ steps.test-redirect-1.outputs.redirect_loop }}" != "false" ]
          then
            echo 'Error: Expected no redirect loop âŒ'
            exit 1
          fi
          echo 'Single redirect test passed âœ…'

      # Test multiple redirects
      - name: 'Test multiple redirects'
        id: test-redirect-3
        uses: ./
        with:
          url: '${{ steps.httpbin.outputs.service-url }}/redirect/3'

      - name: 'Verify multiple redirects test results'
        shell: bash
        run: |
          if [ "${{ steps.test-redirect-3.outputs.valid }}" != "true" ]; then
            echo 'Error: Multiple redirects test failed âŒ'
            exit 1
          fi
          if [ "${{ steps.test-redirect-3.outputs.http_code }}" != "200" ]; then
            echo 'Error: Expected final HTTP 200, got' \
              '${{ steps.test-redirect-3.outputs.http_code }} âŒ'
            exit 1
          fi
          if [ -z "${{ steps.test-redirect-3.outputs.redirect_url }}" ]; then
            echo 'Error: Expected redirect URL to be captured âŒ'
            exit 1
          fi
          if [ "${{ steps.test-redirect-3.outputs.redirect_valid }}" != "true" ]
          then
            echo 'Error: Expected redirect to be valid âŒ'
            exit 1
          fi
          if [ "${{ steps.test-redirect-3.outputs.redirect_loop }}" != "false" ]
          then
            echo 'Error: Expected no redirect loop âŒ'
            exit 1
          fi
          echo 'Multiple redirects test passed âœ…'

      # Test redirect to invalid URL
      - name: 'Test redirect to invalid URL'
        id: test-redirect-404
        uses: ./
        with:
          # yamllint disable rule:line-length
          url: >-
            ${{ steps.httpbin.outputs.service-url }}/redirect-to?url=${{ steps.httpbin.outputs.service-url }}/status/404
          # yamllint enable rule:line-length

      - name: 'Verify redirect to invalid URL test results'
        shell: bash
        run: |
          if [ "${{ steps.test-redirect-404.outputs.valid }}" != "false" ]; then
            echo 'Error: Redirect to 404 should have failed âŒ'
            exit 1
          fi
          if [ "${{ steps.test-redirect-404.outputs.http_code }}" != "404" ]
          then
            echo 'Error: Expected final HTTP 404, got' \
              '${{ steps.test-redirect-404.outputs.http_code }} âŒ'
            exit 1
          fi
          if [ -z "${{ steps.test-redirect-404.outputs.redirect_url }}" ]
          then
            echo 'Error: Expected redirect URL to be captured âŒ'
            exit 1
          fi
          if [ "${{ steps.test-redirect-404.outputs.redirect_valid }}" \
            != "false" ]; then
            echo 'Error: Expected redirect to be invalid âŒ'; exit 1
          fi
          if [ "${{ steps.test-redirect-404.outputs.redirect_loop }}" \
            != "false" ]; then
            echo 'Error: Expected no redirect loop âŒ'; exit 1
          fi
          echo 'Redirect to invalid URL test passed âœ…'

      # Test 500 Internal Server Error
      - name: 'Test 500 Internal Server Error'
        id: test-500
        uses: ./
        with:
          url: '${{ steps.httpbin.outputs.service-url }}/status/500'

      - name: 'Verify 500 Internal Server Error test results'
        shell: bash
        run: |
          if [ "${{ steps.test-500.outputs.valid }}" != "false" ]; then
            echo 'Error: 500 error test should have failed âŒ'
            exit 1
          fi
          if [ "${{ steps.test-500.outputs.http_code }}" != "500" ]; then
            echo 'Error: Expected HTTP 500, got' \
              '${{ steps.test-500.outputs.http_code }} âŒ'
            exit 1
          fi
          echo '500 Internal Server Error test passed âœ…'

      # Generate comprehensive test summary
      # yamllint disable rule:line-length
      - name: 'Generate test summary'
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          # URL Validity Action Test Results ðŸ§ª

          ## Basic Functionality Tests
          | Test | Valid | HTTP Code | Status |
          |------|-------|-----------|--------|
          | Google (External) | ${{ steps.test-valid.outputs.valid }} | ${{ steps.test-valid.outputs.http_code }} | âœ… |
          | Invalid Domain | ${{ steps.test-invalid.outputs.valid }} | ${{ steps.test-invalid.outputs.http_code }} | âœ… |
          | Linux Foundation | ${{ steps.test-lf.outputs.valid }} | ${{ steps.test-lf.outputs.http_code }} | âœ… |

          ## HTTP Status Code Tests
          | Status Code | Valid | HTTP Code | Status |
          |-------------|-------|-----------|---------|
          | 200 OK | ${{ steps.test-200.outputs.valid }} | ${{ steps.test-200.outputs.http_code }} | âœ… |
          | 404 Not Found | ${{ steps.test-404.outputs.valid }} | ${{ steps.test-404.outputs.http_code }} | âœ… |
          | 500 Server Error | ${{ steps.test-500.outputs.valid }} | ${{ steps.test-500.outputs.http_code }} | âœ… |

          ## Redirect Tests
          | Test | Valid | HTTP Code | Redirect URL | Redirect Valid | Loop | Status |
          |------|-------|-----------|--------------|----------------|------|--------|
          | Single Redirect | ${{ steps.test-redirect-1.outputs.valid }} | ${{ steps.test-redirect-1.outputs.http_code }} | ${{ steps.test-redirect-1.outputs.redirect_url }} | ${{ steps.test-redirect-1.outputs.redirect_valid }} | ${{ steps.test-redirect-1.outputs.redirect_loop }} | âœ… |
          | Multiple Redirects | ${{ steps.test-redirect-3.outputs.valid }} | ${{ steps.test-redirect-3.outputs.http_code }} | ${{ steps.test-redirect-3.outputs.redirect_url }} | ${{ steps.test-redirect-3.outputs.redirect_valid }} | ${{ steps.test-redirect-3.outputs.redirect_loop }} | âœ… |
          | Redirect to 404 | ${{ steps.test-redirect-404.outputs.valid }} | ${{ steps.test-redirect-404.outputs.http_code }} | ${{ steps.test-redirect-404.outputs.redirect_url }} | ${{ steps.test-redirect-404.outputs.redirect_valid }} | ${{ steps.test-redirect-404.outputs.redirect_loop }} | âœ… |

          ## New Features Validated âœ¨
          - âœ… **HTTP Status Code Capture**: Captures HTTP response codes (200, 404, 500)
          - âœ… **Redirect URL Capture**: Captures final redirect destinations
          - âœ… **Redirect Validity Check**: Validates if redirected URLs are accessible
          - âœ… **Redirect Loop Detection**: Detects absence of redirect loops
          - âœ… **Error Handling**: Properly handles various HTTP error conditions

          All enhanced URL validity tests completed successfully! ðŸŽ‰
          EOF

          echo 'All comprehensive URL validity tests completed!'
